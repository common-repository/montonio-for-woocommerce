(()=>{"use strict";const e=window.React,t=window.wp.element,n=window.wp.data,o=window.wp.i18n,{registerPaymentMethod:i}=wc.wcBlocksRegistry,{getSetting:r}=wc.wcSettings,{decodeEntities:a}=wp.htmlEntities,{applyFilters:c}=wp.hooks,l=r("wc_montonio_blik_data",{}),s=c("wc_montonio_blik_block_title",a(l.title||(0,o.__)("BLIK","montonio-for-woocommerce")),l),m=c("wc_montonio_blik_block_description",a(l.description),l),d=({setIsFormCompleted:i,setEmbeddedPayment:r,onReinitialization:a})=>{const[c,s]=(0,t.useState)(!1),[m,d]=(0,t.useState)(!1),[u,w]=(0,t.useState)(null),p=(0,n.useSelect)((e=>{const t=e("wc/store/cart").getCustomerData();return t.billingAddress.country||t.shippingAddress.country})),y=(0,t.useCallback)((async()=>{if(s(!0),w(null),window.blikIntentData)return await b(),d(!0),void s(!1);const e=new FormData;e.append("action","get_payment_intent"),e.append("method","blik"),e.append("sandbox_mode",l.sandboxMode);try{const t=await fetch(woocommerce_params.ajax_url,{method:"POST",credentials:"same-origin",body:e}),n=await t.json();if(!n.success)throw new Error(n.data||"Failed to initialize payment");window.blikIntentData=n.data,await b(),d(!0)}catch(e){console.error("Error initializing payment:",e),w(e.message||"Failed to initialize payment")}finally{s(!1)}}),[]),b=async()=>{try{if("undefined"==typeof Montonio||void 0===Montonio.Checkout)throw new Error("Montonio SDK is not loaded");const e=await Montonio.Checkout.EmbeddedPayments.initializePayment({stripePublicKey:window.blikIntentData.stripePublicKey,stripeClientSecret:window.blikIntentData.stripeClientSecret,paymentIntentUuid:window.blikIntentData.uuid,locale:l.locale||"en",country:p||"EE",targetId:"montonio-blik-form"});e.on("change",(e=>{i(e.isCompleted)})),r(e)}catch(e){console.error("Error in initializePayment:",e)}};return(0,t.useEffect)((()=>{m||y()}),[m,y]),(0,t.useEffect)((()=>{a((()=>{d(!1),y()}))}),[a,y]),(0,e.createElement)("div",{id:"montonio-blik-form-wrapper",className:c?"loading":"",style:c?{opacity:.6}:{}},c&&(0,e.createElement)("div",{className:"montonio-loader"},(0,o.__)("Loading...","montonio-for-woocommerce")),u&&(0,e.createElement)("div",{className:"montonio-error"},u),(0,e.createElement)("div",{id:"montonio-blik-form"}))},u=({eventRegistration:i})=>{if("yes"!==l.inlineCheckout)return m?(0,e.createElement)("p",{className:"montonio-payment-block-description"},m):null;const{onPaymentSetup:r,onCheckoutSuccess:a}=i,[c,s]=(0,t.useState)(!1),[u,w]=(0,t.useState)(null),{createErrorNotice:p,removeNotice:y}=(0,n.useDispatch)("core/notices"),b=(0,t.useRef)(null),k=document.getElementById("montonio-blik-form"),E=(0,t.useCallback)((e=>{b.current=e}),[]);return(0,t.useEffect)((()=>{const e=r((()=>{if(y("wc-montonio-blik-error","wc/checkout"),k&&""!==k.innerHTML.trim()&&!c)return{type:"error",message:(0,o.__)("Please fill in the required fields for the payment method.","montonio-for-woocommerce")}})),t=a((async e=>{if(k&&""!==k.innerHTML.trim())try{return{type:"success",redirectUrl:(await u.confirmPayment("yes"===l.sandboxMode)).returnUrl}}catch(e){console.log(e.message);const t=e.message||(0,o.__)("An error occurred during payment processing. Please try again.","montonio-for-woocommerce");return p(t,{context:"wc/checkout"}),b.current&&b.current(),{type:"error",message:t,retry:!0}}}));return()=>{e(),t()}}),[r,a,c,u,p,y]),(0,e.createElement)(e.Fragment,null,m&&(0,e.createElement)("p",{className:"montonio-payment-block-description"},m),(0,e.createElement)(d,{setIsFormCompleted:s,setEmbeddedPayment:w,onReinitialization:E}))},w=()=>(0,e.createElement)("span",null,(0,e.createElement)("img",{src:l.iconurl,alt:"Montonio BLIK"}));i({name:"wc_montonio_blik",label:(0,e.createElement)((()=>(0,e.createElement)("span",null,s,(0,e.createElement)(w,null))),null),content:(0,e.createElement)(u,null),edit:(0,e.createElement)(u,null),canMakePayment:()=>c("wc_montonio_blik_block_enabled",!0,l),ariaLabel:s})})();